{% extends "base.html" %} {% block title %}Dashboard - Smart Curriculum & Attendance{% endblock %} {% block content %}
<!-- Dashboard -->
<section id="dashboard">
    <h2 id="greeting" class="text-4xl font-heading font-bold text-center mb-6">Welcome, {{ student.name or "Student" }}!</h2>
    <h3 class="text-2xl text-center font-semibold text-darkblue mb-2">{{ semester_info or "Semester Error" }} - {{ student.branch or "Unknown Branch" }}</h3>
    <h4 class="text-lg text-center text-gray-600 mb-10">Subjects & Faculty</h4>

    <!-- Subjects -->
    <div class="space-y-4">
        {% for subject in subjects %}
        <div class="bg-white shadow-xl rounded-2xl p-6 flex items-center w-full h-24 pl-1 hover:shadow-2xl transition-shadow duration-300">
            <!-- Big Icon on the Left -->
            <div class="w-24 h-24 flex items-center justify-center mr-6">
                <img src="{{ subject.icon }}" alt="{{ subject.name }}" class="w-16 h-16 object-contain rounded-lg" />
            </div>

            <!-- Subject Information - Stacked Vertically -->
            <div class="flex-1">
                <div class="text-xl font-bold text-darkblue mb-1">{{ subject.name }}</div>
                <div class="text-sm text-gray-600 mb-1"><span class="font-medium">Faculty:</span> {{ subject.faculty }}</div>

                <div class="flex items-center gap-4 text-sm mt-2">
                    <span class="text-gray-500">Code: {{ subject.code }}</span>

                    {% if subject.enrollment_status == 'APPROVED' %} {% if subject.total_classes > 0 %}
                    <span class="px-2 py-1 rounded-full text-xs font-semibold {% if subject.status == 'good' %}bg-green-100 text-green-700 {% elif subject.status == 'warning' %}bg-orange-100 text-orange-700 {% else %}bg-red-100 text-red-700{% endif %}">
                        {{ subject.attendance_percentage }}% ({{ subject.attended_classes }}/{{ subject.total_classes }})
                    </span>
                    {% else %}
                    <span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600">No Attendance Data</span>
                    {% endif %} {% elif subject.enrollment_status == 'PENDING' %}
                    <span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Enrollment Pending</span>
                    {% elif subject.enrollment_status == 'REJECTED' %}
                    <span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800">Enrollment Rejected</span>
                    {% else %}
                    <!-- Not Enrolled -->
                    {% if subject.assigned_classes|length == 0 %}
                    <span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-400">Not assigned</span>
                    {% endif %} {% endif %}
                </div>
            </div>

            <!-- Action Area -->
            <div>
                {% if subject.enrollment_status == 'APPROVED' %}
                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 hover:bg-skyblue hover:text-white transition-colors cursor-pointer">
                    <i data-feather="chevron-right" class="w-4 h-4"></i>
                </div>
                {% elif subject.enrollment_status == 'NOT_ENROLLED' or subject.enrollment_status == 'REJECTED' %} {% if subject.assigned_classes|length > 0 %}
                <div class="flex flex-col gap-2">
                    {% for cls in subject.assigned_classes %}
                    <form action="{{ url_for('views.join_class', class_id=cls.id) }}" method="POST">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-md transition">Join {% if cls.section %}({{ cls.section }}){% endif %}</button>
                    </form>
                    {% endfor %}
                </div>
                {% endif %} {% else %}
                <div class="text-gray-400">
                    <i data-feather="clock" class="w-5 h-5"></i>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Notifications Panel -->
    <div class="mt-10 bg-white shadow-xl rounded-2xl p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-feather="bell" class="w-5 h-5 text-gray-600"></i> Notifications</h2>
        <ul id="notifications" class="space-y-3">
            {% for notification in notifications %}
            <li class="flex items-start gap-3 p-3 rounded-xl shadow-sm animate-fadeIn {{ notification.bg_class }}">
                <span class="text-lg">{{ notification.icon }}</span>
                <p class="text-sm font-medium">{{ notification.message }}</p>
            </li>
            {% endfor %}
        </ul>
    </div>
</section>
{% endblock %} {% block sidebar_content %}
<!-- Full Calendar in Sidebar -->
<div>
    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-feather="calendar" class="w-4 h-4 text-gray-600"></i> Calendar</h3>
    <div id="sideMonthYear" class="text-center font-semibold mb-2">Loading...</div>
    <div class="grid grid-cols-7 gap-1 text-center text-xs mb-1 font-semibold text-gray-600">
        <div>S</div>
        <div>M</div>
        <div>T</div>
        <div>W</div>
        <div>T</div>
        <div>F</div>
        <div>S</div>
    </div>
    <div id="sideCalendar" class="grid grid-cols-7 gap-1 text-center text-xs">
        <div class="p-1 text-xs">Loading...</div>
    </div>
</div>
{% endblock %} {% block scripts %}
<!-- Template Data Injection -->
<script id="template-data" type="application/json">
    {
        "calendarEvents": {{ calendar_events | tojson | safe }},
        "studentName": {{ student.name | tojson | safe }}
    }
</script>

<script>
    // Get template data from JSON script tag
    function getTemplateData() {
        try {
            const dataScript = document.getElementById("template-data");
            return JSON.parse(dataScript.textContent);
        } catch (e) {
            console.warn("Could not parse template data:", e);
            return {};
        }
    }

    const templateData = getTemplateData();

        <!-- Subject-wise Attendance (if you want bars on Dashboard too, ensure this logic runs) -->
        const progressBars = document.querySelectorAll("[data-percentage]");
        progressBars.forEach((bar) => {
             const percentage = parseFloat(bar.getAttribute("data-percentage"));
             setTimeout(() => {
                 bar.style.width = percentage + "%";
             }, 50);
        });
        const hour = new Date().getHours();
        let greet = "Good Evening";
        if (hour < 12) greet = "Good Morning";
        else if (hour < 18) greet = "Good Afternoon";

        const studentName = templateData ? templateData.studentName : "Student";
        const greetingElement = document.getElementById("greeting");
        if (greetingElement) {
            greetingElement.textContent = `${greet}, ${studentName}!`;
        }
    }

    // Set greeting immediately when script runs
    setGreeting();

    // Also set greeting when DOM is fully loaded
    document.addEventListener("DOMContentLoaded", function () {
        setGreeting();

        // Initialize Feather icons
        if (typeof feather !== "undefined") {
            feather.replace();
        }
    });

    // Notifications
    const notiList = document.getElementById("notifications");
    function addNotification(type, message) {
        let icon = "ðŸ“¢",
            bg = "bg-skyblue/10 text-skyblue";
        if (type === "present") {
            icon = "âœ…";
            bg = "bg-green-100 text-green-700";
        }
        if (type === "absent") {
            icon = "âŒ";
            bg = "bg-red-100 text-red-700";
        }
        if (type === "query") {
            icon = "â“";
            bg = "bg-orange-100 text-orange-700";
        }

        const li = document.createElement("li");
        li.className = `flex items-start gap-3 p-3 rounded-xl shadow-sm animate-fadeIn ${bg}`;
        li.innerHTML = `<span class="text-lg">${icon}</span> <p class="text-sm font-medium">${message}</p>`;
        notiList.prepend(li);
    }

    // Academic Calendar - events loaded from JSON
    const events = templateData ? templateData.calendarEvents : {};

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let calendarsInitialized = false;

    function renderSideCalendar(month, year, targetDays, targetHeader) {
        if (!targetDays || !targetHeader) return;

        targetDays.innerHTML = "";
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        targetHeader.textContent = `${monthNames[month]} ${year}`;

        for (let i = 0; i < firstDay; i++) {
            targetDays.appendChild(document.createElement("div"));
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const dayDiv = document.createElement("div");
            dayDiv.className = "p-1 text-xs cursor-pointer hover:bg-gray-100 rounded relative";
            dayDiv.textContent = d;

            const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
            if (events && events[dateStr]) {
                // Set tooltip for hover
                dayDiv.title = events[dateStr];
                dayDiv.setAttribute("data-event", events[dateStr]);

                // Add dot indicator for events
                const eventDot = document.createElement("div");
                eventDot.className = "calendar-event-dot";
                dayDiv.appendChild(eventDot);
            }

            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                dayDiv.className += " calendar-today-sidebar";
            }

            targetDays.appendChild(dayDiv);
        }
    }

    // Initialize calendar when DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
        const sideMonthYear = document.getElementById("sideMonthYear");
        const sideCalendar = document.getElementById("sideCalendar");

        function updateSideCalendar() {
            if (sideMonthYear && sideCalendar) {
                renderSideCalendar(currentMonth, currentYear, sideCalendar, sideMonthYear);
                console.log("Side calendar rendered for dashboard");
            }
        }

        // Initial render
        if (!calendarsInitialized) {
            updateSideCalendar();
            calendarsInitialized = true;
        }
    });

    console.log("Dashboard script loaded");
</script>

<!-- Calendar Today Highlighting CSS -->
<style>
    .calendar-today-sidebar {
        background-color: var(--color-skyblue) !important;
        color: white !important;
        border: 1px solid var(--color-skyblue) !important;
        font-weight: bold !important;
    }

    /* Event dot styling for sidebar calendar */
    .calendar-event-dot {
        position: absolute;
        top: 0;
        right: 0;
        width: 8px;
        height: 8px;
        background-color: var(--color-orange);
        border-radius: 50%;
        transform: translate(2px, -2px);
        z-index: 10;
        border: 1px solid white;
    }
</style>
{% endblock %}
