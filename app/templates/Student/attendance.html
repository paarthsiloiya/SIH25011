{% extends "base.html" %} {% block title %}Attendance - Smart Curriculum & Attendance{% endblock %} {% block content %}
<!-- Attendance Section -->
<section id="attendance">
    <h1 class="text-4xl font-bold mb-10 flex items-center gap-2"><i data-feather="bar-chart" class="w-8 h-8 text-skyblue"></i> Attendance Dashboard</h1>

    <!-- Attendance Statistics Cards -->
    <div class="grid md:grid-cols-4 gap-6 mb-10">
        <div class="bg-white shadow-lg rounded-2xl p-6 text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold">This Week</h2>
            <p class="text-2xl font-bold text-skyblue">{{ attendance_stats.this_week_classes }} Lectures</p>
        </div>
        <div class="bg-white shadow-lg rounded-2xl p-6 text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold">Total Attendance</h2>
            <p class="text-2xl font-bold text-deepred">{{ attendance_stats.attended_classes }} / {{ attendance_stats.total_classes }}</p>
        </div>
        <div class="bg-white shadow-lg rounded-2xl p-6 text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold">Current %</h2>
            {% if attendance_stats.total_classes == 0 %}
            <p class="text-2xl font-bold text-gray-500">No Data</p>
            {% else %} {% if attendance_stats.attendance_percentage >= 75 %}
            <p class="text-2xl font-bold text-green-600">{{ attendance_stats.attendance_percentage }}%</p>
            {% elif attendance_stats.attendance_percentage >= 60 %}
            <p class="text-2xl font-bold text-orange">{{ attendance_stats.attendance_percentage }}%</p>
            {% else %}
            <p class="text-2xl font-bold text-red-600">{{ attendance_stats.attendance_percentage }}%</p>
            {% endif %} {% endif %}
        </div>
        <div class="bg-white shadow-lg rounded-2xl p-6 text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold">Needed for 75%</h2>
            {% if attendance_stats.total_classes == 0 %}
            <p class="text-2xl font-bold text-gray-500">Start Classes</p>
            {% else %}
            <p class="text-2xl font-bold text-orange">{{ attendance_stats.needed_for_75 }} Lectures</p>
            {% endif %}
        </div>
    </div>

    <!-- Missed Classes & Backlogs -->
    <div class="bg-white shadow-xl rounded-2xl p-6 mb-10 fade-in">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-feather="alert-triangle" class="w-6 h-6 text-orange"></i> Missed Classes & Backlogs</h2>
        <ul class="list-disc pl-6 space-y-2">
            {% for backlog in missed_classes %}
            <li><span class="font-semibold">{{ backlog.subject }}:</span> Missed {{ backlog.missed_count }} classes â†’ Backlog: {{ backlog.backlog_item }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Subject-wise Attendance -->
    <div class="bg-white shadow-xl rounded-2xl p-6 mb-10">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-feather="book" class="w-6 h-6 text-skyblue"></i> Subject-wise Attendance</h2>
        <div class="space-y-4">
            {% for subject in subjects %}
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-lg">{{ subject.name }} ({{ subject.code }})</h3>
                    {% if subject.total_classes > 0 %}
                    <span class="px-3 py-1 rounded-full text-sm font-semibold {% if subject.status == 'good' %}bg-green-100 text-green-700 {% elif subject.status == 'warning' %}bg-orange-100 text-orange-700 {% else %}bg-red-100 text-red-700{% endif %}"> {{ subject.attendance_percentage }}% </span>
                    {% else %}
                    <span class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-600">No Classes</span>
                    {% endif %}
                </div>
                {% if subject.total_classes > 0 %}
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
                    <span>Present: {{ subject.attended_classes }}</span>
                    <span>Total: {{ subject.total_classes }}</span>
                    <span>Missed: {{ subject.total_classes - subject.attended_classes }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="h-3 rounded-full {% if subject.status == 'good' %}bg-green-500{% elif subject.status == 'warning' %}bg-orange-500{% else %}bg-red-500{% endif %}" data-percentage="{{ subject.attendance_percentage }}" style="width: 0%"></div>
                </div>
                {% else %}
                <p class="text-sm text-gray-500">No attendance data available yet.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Attendance Chart -->
    <div class="bg-white shadow-xl rounded-2xl p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-feather="pie-chart" class="w-6 h-6 text-skyblue"></i> Attendance Visualization</h2>
        <canvas id="attendanceChart" class="h-64"></canvas>
    </div>
</section>
{% endblock %} {% block sidebar_content %}
<!-- Attendance Summary in Sidebar -->
<div>
    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-feather="trending-up" class="w-4 h-4 text-gray-600"></i> Quick Stats</h3>
    <div class="space-y-3">
        <div class="text-center p-3 bg-gray-50 rounded-lg">
            <div class="text-2xl font-bold {% if attendance_stats.attendance_percentage >= 75 %}text-green-600{% elif attendance_stats.attendance_percentage >= 60 %}text-orange{% else %}text-red-600{% endif %}">{{ attendance_stats.attendance_percentage }}%</div>
            <div class="text-xs text-gray-600">Overall Attendance</div>
        </div>

        <div class="text-xs space-y-1">
            <div class="flex justify-between">
                <span>Present:</span>
                <span class="text-green-600">{{ attendance_stats.attended_classes }}</span>
            </div>
            <div class="flex justify-between">
                <span>Total:</span>
                <span>{{ attendance_stats.total_classes }}</span>
            </div>
            <div class="flex justify-between">
                <span>This Week:</span>
                <span class="text-skyblue">{{ attendance_stats.this_week_classes }}</span>
            </div>
        </div>

        {% if attendance_stats.needed_for_75 > 0 %}
        <div class="text-center p-2 bg-orange-50 rounded text-xs">
            <div class="font-semibold text-orange">{{ attendance_stats.needed_for_75 }}</div>
            <div class="text-orange">classes needed for 75%</div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %} {% block scripts %}
<!-- Template Data Injection -->
<script id="template-data" type="application/json">
    {
        "attendanceChartData": {{ attendance_chart_data | tojson | safe }}
    }
</script>

<script>
    // Get template data from JSON script tag
    function getTemplateData() {
        try {
            const dataScript = document.getElementById("template-data");
            return JSON.parse(dataScript.textContent);
        } catch (e) {
            console.warn("Could not parse template data:", e);
            return {};
        }
    }

    const templateData = getTemplateData();

    document.addEventListener("DOMContentLoaded", function () {
        // Initialize Feather icons
        if (typeof feather !== "undefined") {
            feather.replace();
        }

        // Set progress bars for subject attendance
        const progressBars = document.querySelectorAll("[data-percentage]");
        progressBars.forEach((bar) => {
            const percentage = bar.getAttribute("data-percentage");
            bar.style.width = percentage + "%";
        });

        // Attendance Chart
        const ctx = document.getElementById("attendanceChart");
        if (ctx) {
            const attendanceData = templateData ? templateData.attendanceChartData : null;

            const chartLabels = attendanceData ? attendanceData.labels : ["No Data"];
            const chartData = attendanceData ? attendanceData.data : [0];

            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: "Attendance %",
                            data: chartData,
                            backgroundColor: ["#6CB4EE", "#FCAB64", "#B3001B", "#2D3142", "#F6F6FF", "#90EE90", "#FFB6C1"],
                            borderColor: ["#4A90E2", "#E8994D", "#8B0000", "#1E2332", "#E6E6FF", "#7CFC00", "#FF69B4"],
                            borderWidth: 1,
                        },
                    ],
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } },
            });
        }
    });

    console.log("Attendance script loaded");
</script>
{% endblock %}
