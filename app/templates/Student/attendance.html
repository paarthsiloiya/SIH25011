{% extends "base.html" %} {% block title %}Attendance - Smart Curriculum & Attendance{% endblock %} {% block content %}
<!-- Attendance Section -->
<section id="attendance">
    <h1 class="text-4xl font-bold mb-10 flex items-center gap-2"><i data-feather="bar-chart" class="w-8 h-8 text-skyblue"></i> Attendance Dashboard</h1>

    <!-- Attendance Statistics Cards -->
    <div class="grid md:grid-cols-4 gap-6 mb-10">
        <div class="bg-white shadow-lg rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold text-center mb-2">This Week</h2>
            <p class="text-2xl font-bold text-skyblue text-center">{{ attendance_stats.this_week_classes }} Lectures</p>
        </div>
        <div class="bg-white shadow-lg rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold text-center mb-2">Total Attendance</h2>
            <p class="text-2xl font-bold text-deepred text-center">{{ attendance_stats.attended_classes }} / {{ attendance_stats.total_classes }}</p>
        </div>
        <div class="bg-white shadow-lg rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold text-center mb-2">Current %</h2>
            {% if attendance_stats.total_classes == 0 %}
            <p class="text-2xl font-bold text-gray-500 text-center">No Data</p>
            {% else %} {% if attendance_stats.attendance_percentage >= 75 %}
            <p class="text-2xl font-bold text-green-600 text-center">{{ attendance_stats.attendance_percentage }}%</p>
            {% elif attendance_stats.attendance_percentage >= 60 %}
            <p class="text-2xl font-bold text-orange text-center">{{ attendance_stats.attendance_percentage }}%</p>
            {% else %}
            <p class="text-2xl font-bold text-red-600 text-center">{{ attendance_stats.attendance_percentage }}%</p>
            {% endif %} {% endif %}
        </div>
        <div class="bg-white shadow-lg rounded-2xl p-6 flex flex-col items-center justify-center text-center fade-in hover:scale-105 transition">
            <h2 class="text-lg font-semibold text-center mb-2">Needed for 75%</h2>
            {% if attendance_stats.total_classes == 0 %}
            <p class="text-2xl font-bold text-gray-500 text-center">Start Classes</p>
            {% else %}
            <p class="text-2xl font-bold text-orange text-center">{{ attendance_stats.needed_for_75 }} Lectures</p>
            {% endif %}
        </div>
    </div>

    <!-- Missed Classes & Backlogs -->
    <div class="bg-white shadow-xl rounded-2xl p-6 mb-10 fade-in">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-feather="alert-triangle" class="w-6 h-6 text-orange"></i> Missed Classes & Backlogs</h2>
        <ul class="list-disc pl-6 space-y-2">
            {% for backlog in missed_classes %}
            <li><span class="font-semibold">{{ backlog.subject }}:</span> Missed {{ backlog.missed_count }} classes â†’ Backlog: {{ backlog.backlog_item }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Subject-wise Attendance -->
    <div class="bg-white shadow-xl rounded-2xl p-6 mb-10">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-feather="book" class="w-6 h-6 text-skyblue"></i> Subject-wise Attendance</h2>
        <div class="space-y-4">
            {% for subject in subjects %}
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold text-lg">{{ subject.name }} ({{ subject.code }})</h3>
                    {% if subject.total_classes > 0 %}
                    <span class="px-3 py-1 rounded-full text-sm font-semibold {% if subject.status == 'good' %}bg-green-100 text-green-700 {% elif subject.status == 'warning' %}bg-orange-100 text-orange-700 {% else %}bg-red-100 text-red-700{% endif %}"> {{ subject.attendance_percentage }}% </span>
                    {% else %}
                    <span class="px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-600">No Classes</span>
                    {% endif %}
                </div>
                {% if subject.total_classes > 0 %}
                <div class="flex items-center gap-4 text-sm text-gray-600 mb-2">
                    <span>Present: {{ subject.attended_classes }}</span>
                    <span>Total: {{ subject.total_classes }}</span>
                    <span>Missed: {{ subject.total_classes - subject.attended_classes }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="h-3 rounded-full {% if subject.status == 'good' %}bg-green-500{% elif subject.status == 'warning' %}bg-orange{% else %}bg-red-500{% endif %}" data-percentage="{{ subject.attendance_percentage }}" style="width: 0%"></div>
                </div>
                {% else %}
                <p class="text-sm text-gray-500">No attendance data available yet.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Attendance Chart -->
    <div class="bg-white shadow-xl rounded-2xl p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-feather="pie-chart" class="w-6 h-6 text-skyblue"></i> Attendance Visualization</h2>
        <canvas id="attendanceChart" class="h-64"></canvas>
    </div>
</section>
{% endblock %} {% block sidebar_content %}
<!-- Attendance Summary in Sidebar -->
<div>
    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-feather="trending-up" class="w-4 h-4 text-gray-600"></i> Quick Stats</h3>
    <div class="space-y-3">
        <div class="text-center p-3 bg-gray-50 rounded-lg">
            <div class="text-2xl font-bold {% if attendance_stats.attendance_percentage >= 75 %}text-green-600{% elif attendance_stats.attendance_percentage >= 60 %}text-orange{% else %}text-red-600{% endif %}">{{ attendance_stats.attendance_percentage }}%</div>
            <div class="text-xs text-gray-600">Overall Attendance</div>
        </div>

        <div class="text-xs space-y-1">
            <div class="flex justify-between">
                <span>Present:</span>
                <span class="text-green-600">{{ attendance_stats.attended_classes }}</span>
            </div>
            <div class="flex justify-between">
                <span>Total:</span>
                <span>{{ attendance_stats.total_classes }}</span>
            </div>
            <div class="flex justify-between">
                <span>This Week:</span>
                <span class="text-skyblue">{{ attendance_stats.this_week_classes }}</span>
            </div>
        </div>

        {% if attendance_stats.needed_for_75 > 0 %}
        <div class="text-center p-2 bg-orange-50 rounded text-xs">
            <div class="font-semibold text-orange">{{ attendance_stats.needed_for_75 }}</div>
            <div class="text-orange">classes needed for 75%</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Mini Calendar in Sidebar -->
<div class="mt-6">
    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-feather="calendar" class="w-4 h-4 text-gray-600"></i> Calendar</h3>
    <div id="sideMonthYear" class="text-center font-semibold mb-2">Loading...</div>
    <div class="grid grid-cols-7 gap-1 text-center text-xs mb-1 font-semibold text-gray-600">
        <div>S</div>
        <div>M</div>
        <div>T</div>
        <div>W</div>
        <div>T</div>
        <div>F</div>
        <div>S</div>
    </div>
    <div id="sideCalendar" class="grid grid-cols-7 gap-1 text-center text-xs">
        <div class="p-1 text-xs">Loading...</div>
    </div>
</div>
{% endblock %} {% block scripts %}
<!-- Template Data Injection -->
<script id="template-data" type="application/json">
    {
        "attendanceChartData": {{ attendance_chart_data | tojson | safe }},
        "calendarEvents": {{ calendar_events | tojson | safe }}
    }
</script>

<script>
    // Get template data from JSON script tag
    function getTemplateData() {
        try {
            const dataScript = document.getElementById("template-data");
            return JSON.parse(dataScript.textContent);
        } catch (e) {
            console.warn("Could not parse template data:", e);
            return {};
        }
    }

    const templateData = getTemplateData();

    document.addEventListener("DOMContentLoaded", function () {
        // Initialize Feather icons
        if (typeof feather !== "undefined") {
            feather.replace();
        }

        // Set progress bars for subject attendance
        const progressBars = document.querySelectorAll("[data-percentage]");
        progressBars.forEach((bar) => {
            const percentage = parseFloat(bar.getAttribute("data-percentage"));
            // Ensure width is set after a microtask to allow CSS transition if any
            setTimeout(() => {
                bar.style.width = percentage + "%";
            }, 50);
        });

        // Attendance Chart
        const ctx = document.getElementById("attendanceChart");
        if (ctx) {
            const attendanceData = templateData ? templateData.attendanceChartData : null;

            const chartLabels = attendanceData ? attendanceData.labels : ["No Data"];
            const chartData = attendanceData ? attendanceData.data : [0];

            // Get the darkblue color from CSS variables or use fallback
            const getDarkBlueColor = () => {
                const testEl = document.createElement("div");
                testEl.style.color = "var(--color-darkblue)";
                document.body.appendChild(testEl);
                const computedColor = window.getComputedStyle(testEl).color;
                document.body.removeChild(testEl);

                // If CSS variable didn't work, use the direct color value
                return computedColor && computedColor !== "rgba(0, 0, 0, 0)" ? computedColor : "hsla(218, 17%, 22%, 1)";
            };

            const darkBlueColor = getDarkBlueColor();

            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: "Attendance %",
                            data: chartData,
                            backgroundColor: darkBlueColor,
                            borderColor: darkBlueColor,
                            borderWidth: 1,
                        },
                    ],
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } },
            });
        }

        // Calendar functionality
        const events = templateData ? templateData.calendarEvents : {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        function renderSideCalendar(month, year, targetDays, targetHeader) {
            if (!targetDays || !targetHeader) return;

            targetDays.innerHTML = "";
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            targetHeader.textContent = `${monthNames[month]} ${year}`;

            for (let i = 0; i < firstDay; i++) {
                targetDays.appendChild(document.createElement("div"));
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dayDiv = document.createElement("div");
                dayDiv.className = "p-1 text-xs cursor-pointer hover:bg-gray-100 rounded relative";
                dayDiv.textContent = d;

                const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
                if (events && events[dateStr]) {
                    // Set tooltip for hover
                    dayDiv.title = events[dateStr];
                    dayDiv.setAttribute("data-event", events[dateStr]);

                    // Add dot indicator for events
                    const eventDot = document.createElement("div");
                    eventDot.className = "calendar-event-dot";
                    dayDiv.appendChild(eventDot);
                }

                const today = new Date();
                if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                    dayDiv.className += " calendar-today-sidebar";
                }

                targetDays.appendChild(dayDiv);
            }
        }

        // Initialize sidebar calendar
        const sideMonthYear = document.getElementById("sideMonthYear");
        const sideCalendar = document.getElementById("sideCalendar");

        if (sideMonthYear && sideCalendar) {
            renderSideCalendar(currentMonth, currentYear, sideCalendar, sideMonthYear);
        }
    });

    console.log("Attendance script loaded");
</script>

<!-- Calendar Today Highlighting CSS -->
<style>
    .calendar-today-sidebar {
        background-color: var(--color-skyblue) !important;
        color: white !important;
        border: 1px solid var(--color-skyblue) !important;
        font-weight: bold !important;
    }

    /* Event dot styling for sidebar calendar */
    .calendar-event-dot {
        position: absolute;
        top: 0;
        right: 0;
        width: 8px;
        height: 8px;
        background-color: var(--color-orange);
        border-radius: 50%;
        transform: translate(2px, -2px);
        z-index: 10;
        border: 1px solid white;
    }
</style>
{% endblock %}
