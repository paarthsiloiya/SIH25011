{% extends "base.html" %} {% block title %}Calendar - Smart Curriculum & Attendance{% endblock %} {% block content %}
<!-- Calendar Section -->
<section id="calendar">
    <h1 class="text-4xl font-bold mb-10 flex items-center gap-2"><i data-feather="calendar" class="w-8 h-8 text-skyblue"></i> Academic Calendar</h1>

    <!-- Main Calendar -->
    <div class="bg-white shadow-xl rounded-2xl p-6 max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="bg-skyblue text-white px-4 py-2 rounded-lg hover:bg-blue-500 transition">&lt;</button>
            <div id="monthYear" class="text-2xl font-bold text-center">Loading...</div>
            <button id="nextMonth" class="bg-skyblue text-white px-4 py-2 rounded-lg hover:bg-blue-500 transition">&gt;</button>
        </div>
        <div class="grid grid-cols-7 gap-3 text-center mb-4 font-semibold text-gray-600">
            <div class="py-2">Sun</div>
            <div class="py-2">Mon</div>
            <div class="py-2">Tue</div>
            <div class="py-2">Wed</div>
            <div class="py-2">Thu</div>
            <div class="py-2">Fri</div>
            <div class="py-2">Sat</div>
        </div>
        <div id="calendarDays" class="grid grid-cols-7 gap-3 text-center min-h-[200px] border border-gray-200 p-2">
            <div class="p-2 text-center">Loading calendar...</div>
        </div>
    </div>

    <!-- Upcoming Events -->
    <div class="mt-10 max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-feather="clock" class="w-6 h-6 text-skyblue"></i> Upcoming Events</h3>
        <ul id="eventList" class="space-y-2 text-sm">
            <!-- Events will be populated dynamically by JavaScript -->
        </ul>
    </div>

    <!-- Calendar Legend -->
    <div class="mt-10 max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6">
        <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-feather="info" class="w-6 h-6 text-skyblue"></i> Calendar Legend</h3>
        <div class="grid md:grid-cols-3 gap-4">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-skyblue rounded"></div>
                <span class="text-sm">Academic Events</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-green-500 rounded"></div>
                <span class="text-sm">Holidays</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-orange rounded"></div>
                <span class="text-sm">Exams</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-deepred rounded"></div>
                <span class="text-sm">Deadlines</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-purple-500 rounded"></div>
                <span class="text-sm">Events</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-yellow-500 rounded border-2 border-skyblue"></div>
                <span class="text-sm">Today</span>
            </div>
        </div>
    </div>
</section>
{% endblock %} {% block sidebar_content %}
<!-- Mini Calendar in Sidebar -->
<div>
    <h3 class="font-bold mb-2 flex items-center gap-2"><i data-feather="calendar" class="w-4 h-4 text-gray-600"></i> Quick View</h3>
    <div id="sideMonthYear" class="text-center font-semibold mb-2">Loading...</div>
    <div class="grid grid-cols-7 gap-1 text-center text-xs mb-1 font-semibold text-gray-600">
        <div>S</div>
        <div>M</div>
        <div>T</div>
        <div>W</div>
        <div>T</div>
        <div>F</div>
        <div>S</div>
    </div>
    <div id="sideCalendar" class="grid grid-cols-7 gap-1 text-center text-xs">
        <div class="p-1 text-xs">Loading...</div>
    </div>

    <!-- Today's Events -->
    <div class="mt-4">
        <h4 class="font-semibold text-sm mb-2">Today's Events</h4>
        <div id="todayEvents" class="text-xs space-y-1">
            <!-- Today's events will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<!-- Template Data Injection -->
<script id="template-data" type="application/json">
    {
        "calendarEvents": {{ calendar_events | tojson | safe }}
    }
</script>

<!-- Calendar Today Highlighting CSS -->
<style>
    /* Ensure today highlighting takes priority over event styling */
    .calendar-today {
        background-color: #6cb4ee !important;
        color: white !important;
        border: 2px solid #6cb4ee !important;
        font-weight: bold !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }

    .calendar-today-sidebar {
        background-color: #6cb4ee !important;
        color: white !important;
        border: 1px solid #6cb4ee !important;
        font-weight: bold !important;
    }

    .calendar-event {
        background-color: #e0f2fe;
        border: 1px solid #6cb4ee;
        color: #0277bd;
    }
</style>

<script>
    // Get template data from JSON script tag
    function getTemplateData() {
        try {
            const dataScript = document.getElementById("template-data");
            return JSON.parse(dataScript.textContent);
        } catch (e) {
            console.warn("Could not parse template data:", e);
            return {};
        }
    }

    const templateData = getTemplateData();

    // Academic Calendar - events loaded from JSON
    const events = templateData ? templateData.calendarEvents : {};

    // Populate upcoming events list
    function populateUpcomingEvents() {
        const eventList = document.getElementById("eventList");
        if (!eventList || !events) return;

        const today = new Date();
        const upcomingEvents = [];

        // Get events from today onwards, limit to next 10 events
        Object.keys(events)
            .filter((dateStr) => new Date(dateStr) >= today)
            .sort()
            .slice(0, 10)
            .forEach((dateStr) => {
                const eventDate = new Date(dateStr);
                const eventInfo = events[dateStr];
                upcomingEvents.push({
                    date: eventDate.toLocaleDateString("en-US", { month: "short", day: "numeric" }),
                    title: eventInfo,
                    fullDate: dateStr,
                });
            });

        // Clear existing events
        eventList.innerHTML = "";

        // Add events to the list
        upcomingEvents.forEach((event) => {
            const li = document.createElement("li");
            li.className = "flex justify-between items-center p-2 hover:bg-gray-50 rounded";
            li.innerHTML = `<span>${event.title}</span><span class="text-gray-500">${event.date}</span>`;
            eventList.appendChild(li);
        });

        // If no upcoming events, show a message
        if (upcomingEvents.length === 0) {
            eventList.innerHTML = '<li class="text-gray-500 text-center py-4">No upcoming events</li>';
        }
    }

    // Populate today's events
    function populateTodayEvents() {
        const todayEvents = document.getElementById("todayEvents");
        if (!todayEvents || !events) return;

        const today = new Date();
        const todayStr = today.toISOString().split("T")[0];

        if (events[todayStr]) {
            todayEvents.innerHTML = `<div class="p-2 bg-skyblue/10 rounded text-skyblue">${events[todayStr]}</div>`;
        } else {
            todayEvents.innerHTML = '<div class="text-gray-500">No events today</div>';
        }
    }

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let calendarsInitialized = false;

    function renderCalendar(month, year, targetDays, targetHeader) {
        if (!targetDays || !targetHeader) return;

        targetDays.innerHTML = "";
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        targetHeader.textContent = `${monthNames[month]} ${year}`;

        // Add empty cells for days before the first day of the month
        for (let i = 0; i < firstDay; i++) {
            targetDays.appendChild(document.createElement("div"));
        }

        // Add days of the month
        for (let d = 1; d <= daysInMonth; d++) {
            const dayDiv = document.createElement("div");
            dayDiv.className = "p-3 cursor-pointer hover:bg-gray-100 rounded-lg border border-gray-200 min-h-[50px] flex flex-col items-center justify-center";
            dayDiv.textContent = d;

            const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
            if (events && events[dateStr]) {
                dayDiv.className += " calendar-event";
                dayDiv.title = events[dateStr];
                const eventDiv = document.createElement("div");
                eventDiv.className = "text-xs mt-1 text-center";
                eventDiv.textContent = "â€¢";
                dayDiv.appendChild(eventDiv);
            }

            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                dayDiv.className += " calendar-today";
            }

            targetDays.appendChild(dayDiv);
        }
    }

    function renderSideCalendar(month, year, targetDays, targetHeader) {
        if (!targetDays || !targetHeader) return;

        targetDays.innerHTML = "";
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        targetHeader.textContent = `${monthNames[month]} ${year}`;

        for (let i = 0; i < firstDay; i++) {
            targetDays.appendChild(document.createElement("div"));
        }

        for (let d = 1; d <= daysInMonth; d++) {
            const dayDiv = document.createElement("div");
            dayDiv.className = "p-1 text-xs cursor-pointer hover:bg-gray-100 rounded";
            dayDiv.textContent = d;

            const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
            if (events && events[dateStr]) {
                dayDiv.className += " bg-skyblue text-white font-bold";
                dayDiv.title = events[dateStr];
            }

            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && d === today.getDate()) {
                dayDiv.className += " calendar-today-sidebar";
            }

            targetDays.appendChild(dayDiv);
        }
    }

    // Initialize calendars when DOM is ready
    document.addEventListener("DOMContentLoaded", function () {
        console.log("Initializing calendars...");

        // Initialize Feather icons first
        if (typeof feather !== "undefined") {
            feather.replace();
        }

        // Populate events
        populateUpcomingEvents();
        populateTodayEvents();

        const monthYear = document.getElementById("monthYear");
        const calendarDays = document.getElementById("calendarDays");
        const sideMonthYear = document.getElementById("sideMonthYear");
        const sideCalendar = document.getElementById("sideCalendar");
        const prevBtn = document.getElementById("prevMonth");
        const nextBtn = document.getElementById("nextMonth");

        function updateMainCalendar() {
            if (monthYear && calendarDays) {
                renderCalendar(currentMonth, currentYear, calendarDays, monthYear);
                console.log("Main calendar rendered");
            }
        }

        function updateSideCalendar() {
            if (sideMonthYear && sideCalendar) {
                renderSideCalendar(currentMonth, currentYear, sideCalendar, sideMonthYear);
                console.log("Side calendar rendered");
            }
        }

        // Initial render
        if (!calendarsInitialized) {
            updateMainCalendar();
            updateSideCalendar();
            calendarsInitialized = true;
        }

        // Navigation buttons
        if (prevBtn) {
            prevBtn.addEventListener("click", function () {
                try {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    updateMainCalendar();
                    updateSideCalendar();
                } catch (e) {
                    console.error("Error in prev button:", e);
                }
            });
        }

        if (nextBtn) {
            nextBtn.addEventListener("click", function () {
                try {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    updateMainCalendar();
                    updateSideCalendar();
                } catch (e) {
                    console.error("Error in next button:", e);
                }
            });
        }

        console.log("Calendar initialization complete");
    });

    console.log("Calendar script loaded");
</script>
{% endblock %}
